<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>You Madrugada</title>
    <style>
        :root{
            --bg:#f5f5f5;
            --card:#fff;
            --muted:#6b7280;
            --accent:#007bff;
            --radius:10px;
        }

        body {
            font-family: Inter, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            background-color: var(--bg);
            color: #111827;
        }

        h1 { margin: 0 0 12px 0; font-size: 1.6rem; }
        img.logo { max-width:200px; display:block; margin:8px 0 20px 0; border-radius:8px; }

        .container {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 20px;
            margin-top: 16px;
        }

        .upload-section, .gallery-section {
            background: var(--card);
            padding: 18px;
            border-radius: var(--radius);
            box-shadow: 0 6px 18px rgba(15,23,42,0.06);
        }

        /* Gallery */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 14px;
            margin-top: 12px;
        }

        .gallery-item {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(15,23,42,0.04);
            display:flex;
            flex-direction:column;
            transition: transform .15s ease, box-shadow .15s ease;
            position:relative;
            min-height:120px;
            cursor: pointer;
        }
        .gallery-item:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(15,23,42,0.08); }

        .thumb {
            height:96px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            padding:10px;
            background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
        }

        .icon-badge {
            width:56px;
            height:56px;
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            color:#fff;
            font-size:18px;
            flex-shrink:0;
        }

        /* colors per type */
        .t-video { background: linear-gradient(135deg,#7c3aed,#06b6d4); }
        .t-audio { background: linear-gradient(135deg,#ef4444,#f59e0b); }
        .t-image { background: linear-gradient(135deg,#10b981,#06b6d4); }
        .t-pdf   { background: linear-gradient(135deg,#ef4444,#9b2c2c); }
        .t-text  { background: linear-gradient(135deg,#6366f1,#3b82f6); }
        .t-other { background: linear-gradient(135deg,#6b7280,#94a3b8); }

        .meta {
            padding: 10px 12px;
            display:flex;
            flex-direction:column;
            gap:6px;
        }
        .name {
            font-size: 13px;
            color: #0f172a;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        .sub {
            font-size: 12px;
            color: var(--muted);
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
        }

        /* Actions overlay (visible on hover) */
        .overlay-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display:flex;
            gap:8px;
            opacity:0;
            transform: translateY(-6px);
            transition: all .15s ease;
        }
        .gallery-item:hover .overlay-actions {
            opacity:1;
            transform: translateY(0);
        }

        .btn {
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(15,23,42,0.06);
            padding:6px 8px;
            border-radius:8px;
            font-size:12px;
            cursor:pointer;
            color:#0f172a;
            text-decoration:none;
            display:inline-flex;
            align-items:center;
            gap:6px;
        }
        .btn:active { transform: translateY(1px); }

        /* Upload form */
        form { display:flex; gap:10px; align-items:center; }
        input[type="file"] { flex:1; padding:10px; border-radius:8px; border:1px solid #e6e9ee; background:#fafafa; }
        button.submit { background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }

        /* player container */
        #player-container {
            margin-top: 14px;
            background: #0b1220;
            border-radius: 10px;
            padding: 12px;
            color: white;
            min-height: 120px;
        }

        #player-container video, #player-container audio, #player-container img, #player-container iframe {
            width:100%;
            border-radius:8px;
            display:block;
        }

        /* small helpers */
        .size-badge { font-size:11px; color:var(--muted); }
        .ext-badge { font-size:11px; color:#fff; padding:4px 6px; border-radius:6px; opacity:.95; }

        /* responsive */
        @media (max-width:880px){
            .container { grid-template-columns: 1fr; }
            img.logo { max-width:160px; }
        }
    </style>
</head>
<body>
    <h1>Bem-vindo ao You Madrugada</h1>
    <img class="logo" src="OIP.webp">
    <link rel="icon" href="favicon.ico">

    <h1>Enviar e Reproduzir Arquivo</h1>

    <div class="container">
        <div class="upload-section">
            <h2>Enviar Arquivo</h2>
            <form id="uploadForm">
                <input type="file" id="fileInput" accept="*/*" />
                <button type="submit" class="submit">Enviar</button>
            </form>

            <div id="status" style="margin-top: 10px; padding: 10px; display: none; border-radius: 6px;"></div>
            <div id="player-container"></div>
        </div>

        <div class="gallery-section">
            <h2>Arquivos Salvos</h2>
            <div id="gallery" class="gallery"></div>
        </div>
    </div>

<script>
    // helpers
    function extOf(name) { return (name || '').split('.').pop().toLowerCase(); }
    function formatSize(bytes){
        if (bytes == null) return '';
        const units = ['B','KB','MB','GB','TB'];
        let i=0; let n = Number(bytes) || 0;
        while(n >= 1024 && i < units.length-1){ n = n/1024; i++; }
        return n.toFixed(n < 10 ? 2:1) + ' ' + units[i];
    }
    function typeClass(ext){
        if (!ext) return 't-other';
        if (['mp4','webm','ogg','avi','mkv','mov'].includes(ext)) return 't-video';
        if (['mp3','wav','aac','flac','m4a'].includes(ext)) return 't-audio';
        if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 't-image';
        if (ext === 'pdf') return 't-pdf';
        if (['txt','md','csv','json','log','xml','html','js','css'].includes(ext)) return 't-text';
        return 't-other';
    }

    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const statusDiv = document.getElementById('status');
    const galleryDiv = document.getElementById('gallery');

    carregarGaleria();

    form.addEventListener('submit', async function(e){
        e.preventDefault();
        const file = fileInput.files[0];
        if (!file){ alert('Por favor, selecione um arquivo.'); return; }

        const formData = new FormData();
        formData.append('file', file);

        statusDiv.style.display = 'block';
        statusDiv.textContent = 'Enviando arquivo...';
        statusDiv.style.color = 'blue';

        try {
            const response = await fetch('/upload', { method:'POST', body: formData });
            if (response.ok){
                await response.json().catch(()=>{});
                statusDiv.textContent = '✓ Arquivo salvo com sucesso!';
                statusDiv.style.color = 'green';
                fileInput.value = '';
                reproduzirArquivo(file);
                setTimeout(carregarGaleria, 600);
            } else {
                const errText = await response.text().catch(()=>'' );
                statusDiv.textContent = '✗ Erro ao salvar arquivo' + (errText ? (': '+errText):'');
                statusDiv.style.color = 'red';
            }
        } catch(err){
            statusDiv.textContent = '✗ Erro: ' + err.message;
            statusDiv.style.color = 'red';
        }
    });

    async function carregarGaleria(){
        try {
            const resp = await fetch('/list');
            const files = await resp.json();
            galleryDiv.innerHTML = '';
            if (!files || files.length === 0){
                galleryDiv.innerHTML = '<p style="color:var(--muted)">Nenhum arquivo ainda</p>';
                return;
            }

            files.forEach(file => {
                const name = file.name || file.filename || 'sem_nome';
                const size = file.size || file.filesize || null;
                const ext = extOf(name);
                const tclass = typeClass(ext);

                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.title = name;

                // overlay actions
                const overlay = document.createElement('div');
                overlay.className = 'overlay-actions';

                const btnPreview = document.createElement('button');
                btnPreview.className = 'btn';
                btnPreview.textContent = 'Visualizar';
                btnPreview.addEventListener('click', (ev)=>{ ev.stopPropagation(); reproduzirDoServidor(file); });

                const aDownload = document.createElement('a');
                aDownload.className = 'btn';
                aDownload.textContent = 'Baixar';
                const path = file.path || file.url || file.filepath || encodeURIComponent(name);
                aDownload.href = '/' + path;
                aDownload.setAttribute('download', name);

                overlay.appendChild(btnPreview);
                overlay.appendChild(aDownload);

                // thumb
                const thumb = document.createElement('div');
                thumb.className = 'thumb';

                const badge = document.createElement('div');
                badge.className = 'icon-badge ' + tclass;
                // badge text: short label
                const lab = (isNaN(parseInt(ext)) && ext) ? ext.toUpperCase().slice(0,4) : 'FILE';
                badge.textContent = lab;

                const extBadge = document.createElement('div');
                extBadge.className = 'ext-badge';
                extBadge.style.background = 'rgba(0,0,0,0.08)';
                extBadge.textContent = ext || '';

                thumb.appendChild(badge);
                thumb.appendChild(extBadge);

                // meta
                const meta = document.createElement('div');
                meta.className = 'meta';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'name';
                nameDiv.textContent = name;

                const sub = document.createElement('div');
                sub.className = 'sub';
                const sizeSpan = document.createElement('span');
                sizeSpan.className = 'size-badge';
                sizeSpan.textContent = size ? formatSize(size) : '';

                const infoSpan = document.createElement('span');
                infoSpan.style.color = 'var(--muted)';
                infoSpan.style.fontSize = '11px';
                infoSpan.textContent = file.updatedAt ? (new Date(file.updatedAt)).toLocaleDateString() : '';

                sub.appendChild(sizeSpan);
                sub.appendChild(infoSpan);

                meta.appendChild(nameDiv);
                meta.appendChild(sub);

                item.appendChild(thumb);
                item.appendChild(meta);
                item.appendChild(overlay);

                item.addEventListener('click', ()=> reproduzirDoServidor(file));

                galleryDiv.appendChild(item);
            });

        } catch(err){
            console.error('Erro ao carregar galeria:', err);
            galleryDiv.innerHTML = '<p style="color:var(--muted)">Erro ao carregar arquivos</p>';
        }
    }

    // local preview
    function reproduzirArquivo(file){
        const ext = extOf(file.name);
        const url = URL.createObjectURL(file);
        const container = document.getElementById('player-container');
        container.innerHTML = '';

        if (['mp4','webm','ogg','mov','mkv','avi'].includes(ext)){
            const video = document.createElement('video');
            video.src = url; video.controls = true;
            container.appendChild(video);
        } else if (['mp3','wav','aac','flac','m4a'].includes(ext)){
            const audio = document.createElement('audio');
            audio.src = url; audio.controls = true;
            container.appendChild(audio);
        } else if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)){
            const img = document.createElement('img');
            img.src = url; container.appendChild(img);
        } else if (ext === 'pdf'){
            const iframe = document.createElement('iframe');
            iframe.src = url; iframe.height = '640'; container.appendChild(iframe);
        } else if (['txt','md','csv','json','log','xml','html','js','css'].includes(ext)){
            const reader = new FileReader();
            reader.onload = ()=>{ const pre = document.createElement('pre'); pre.textContent = reader.result; container.appendChild(pre); };
            reader.readAsText(file);
        } else {
            const a = document.createElement('a');
            a.href = url; a.download = file.name; a.className='btn'; a.textContent = 'Baixar ' + file.name;
            container.appendChild(a);
        }
    }

    // server preview / download
    async function reproduzirDoServidor(file){
        const name = file.name || file.filename || 'arquivo';
        const path = file.path || file.url || file.filepath || encodeURIComponent(name);
        const url = '/' + path;
        const ext = extOf(name);
        const container = document.getElementById('player-container');
        container.innerHTML = '';

        if (['mp4','webm','ogg','mov','mkv','avi'].includes(ext)){
            const video = document.createElement('video'); video.src = url; video.controls = true; container.appendChild(video);
        } else if (['mp3','wav','aac','flac','m4a'].includes(ext)){
            const audio = document.createElement('audio'); audio.src = url; audio.controls = true; container.appendChild(audio);
        } else if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)){
            const img = document.createElement('img'); img.src = url; container.appendChild(img);
        } else if (ext === 'pdf'){
            const iframe = document.createElement('iframe'); iframe.src = url; iframe.height = '640'; container.appendChild(iframe);
        } else if (['txt','md','csv','json','log','xml','html','js','css'].includes(ext)){
            try {
                const r = await fetch(url);
                const text = await r.text();
                const pre = document.createElement('pre'); pre.textContent = text; container.appendChild(pre);
            } catch(e){
                container.innerText = 'Erro ao carregar arquivo de texto.';
            }
        } else {
            const a = document.createElement('a'); a.href = url; a.download = name; a.className='btn'; a.textContent = 'Baixar ' + name;
            container.appendChild(a);
        }
    }
</script>
</body>
</html>
